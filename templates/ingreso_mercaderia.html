{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-1">
    <div class="card shadow-sm">
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                    <i class="fas fa-boxes"></i> Ingreso de Mercadería
                </h5>
                <a href="{% url 'products_app:lista_ingresos' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Cancelar
                </a>
            </div>

            <p class="text-muted mb-3">Fecha: {{ fecha_actual }}</p>

            <input type="text" id="scanner" class="form-control form-control-sm mb-3"
                   placeholder="Escaneá el código de barras..." autofocus>

            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th>Nombre</th>
                            <th>Cantidad</th>
                            <th class="text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="detalle-ingreso"></tbody>
                </table>
            </div>

            <div class="text-end">
                <button class="btn btn-success btn-sm" onclick="confirmarIngreso()">
                    <i class="fas fa-check-circle"></i> Confirmar Ingreso
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de producto -->
<div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title text-primary" id="modal-nombre"><i class="fas fa-box"></i> Producto</h6>
        <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modal-img" src="" alt="Imagen" class="img-fluid rounded shadow-sm mb-3" style="max-height: 150px;">
        <p class="mb-1">Código: <span id="modal-codigo"></span></p>
        <p class="mb-3">Stock actual: <span id="modal-stock">0</span></p>
        <input type="number" id="modal-cantidad" class="form-control form-control-sm" placeholder="Cantidad entregada">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary btn-sm" onclick="confirmarProducto()">
            <i class="fas fa-plus-circle"></i> Agregar
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Modal de mensaje -->
<div class="modal fade" id="modalMensaje" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning-subtle">
          <h6 class="modal-title text-warning"><i class="fas fa-exclamation-circle"></i> Aviso</h6>
          <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="modalMensajeTexto" class="mb-0 text-dark"></p>
        </div>
      </div>
    </div>
</div>
<script>
    let productoActual = null;
    const productosIngresados = new Map();
    const localId = 1;
    const scanner = document.getElementById("scanner");

    const modalElement = document.getElementById("modalProducto");
    const modal = new bootstrap.Modal(modalElement);

    const modalImg = document.getElementById("modal-img");
    const modalNombre = document.getElementById("modal-nombre");
    const modalStock = document.getElementById("modal-stock");
    const modalCantidad = document.getElementById("modal-cantidad");

    const modalMensaje = new bootstrap.Modal(document.getElementById("modalMensaje"));
    const modalMensajeTexto = document.getElementById("modalMensajeTexto");

    scanner.addEventListener("change", function () {
        const codigo = this.value.trim();
        if (!codigo) return;

        fetch(`/productos/buscar_producto_por_codigo/?codigo=${codigo}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const p = data.producto;

                    // Calcular stock real actual después de ingresos previos
                    let stockRestante = parseInt(p.stock ?? 0);
                    if (productosIngresados.has(codigo)) {
                        const fila = document.querySelector(`tr[data-producto-id='${p.id}']`);
                        const tdCantidad = fila.querySelector(".cantidad");
                        stockRestante -= parseInt(tdCantidad.textContent);
                    }

                    if (stockRestante <= 0) {
                        mostrarMensaje("No hay stock disponible para este producto.");
                        scanner.value = "";
                        return;
                    }

                    if (productosIngresados.has(codigo)) {
                        const fila = document.querySelector(`tr[data-producto-id='${p.id}']`);
                        const tdCantidad = fila.querySelector(".cantidad");
                        let nuevaCantidad = parseInt(tdCantidad.textContent) + 1;

                        // Verificar stock restante
                        if (nuevaCantidad > parseInt(p.stock)) {
                            mostrarMensaje("No hay stock suficiente para agregar otra unidad.");
                            scanner.value = "";
                            return;
                        }

                        tdCantidad.textContent = nuevaCantidad;
                    } else {
                        agregarFila(p, 1);
                        productosIngresados.set(codigo, p.id);
                    }
                } else {
                    mostrarMensaje("Artículo no encontrado.");
                }
            })
            .catch(err => {
                mostrarMensaje("Error al buscar el producto.");
                console.error(err);
            });

        this.value = "";
    });

    function confirmarProducto() {
        const cantidad = parseInt(modalCantidad.value);
        if (!cantidad || cantidad <= 0) {
            alert("Ingresá una cantidad válida.");
            return;
        }

        agregarFila(productoActual, cantidad);
        productosIngresados.set(productoActual.codigo_barras, productoActual.id);
        modal.hide();
        scanner.focus();
    }
    function mostrarMensaje(texto) {
        modalMensajeTexto.textContent = texto;
        modalMensaje.show();
    }

    function agregarFila(producto, cantidad) {
        const fila = document.createElement("tr");
        fila.setAttribute("data-producto-id", producto.id);
        fila.innerHTML = `
            <td><img src="${producto.foto}" alt="Imagen" style="height: 60px;" class="rounded shadow-sm"></td>
            <td>${producto.nombre}</td>
            <td class="cantidad">${cantidad}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); productosIngresados.delete('${producto.codigo_barras}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        document.getElementById("detalle-ingreso").appendChild(fila);
    }


    function confirmarIngreso() {
        const productos = [];
        document.querySelectorAll("#detalle-ingreso tr").forEach(tr => {
            const id = tr.getAttribute("data-producto-id");
            const cantidad = tr.children[2].textContent;
            productos.push({ id: id, cantidad: cantidad });
        });

        if (productos.length === 0) {
            alert("No hay productos para ingresar.");
            return;
        }

        fetch("/productos/registrar_ingreso/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                local_id: localId,
                productos: productos
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Ingreso confirmado.");
                window.location.href = "{% url 'products_app:lista_ingresos' %}";
            } else {
                alert("Error al confirmar ingreso.");
            }
        })
        .catch(err => {
            alert("Error al enviar los datos.");
            console.error(err);
        });
    }
</script>
{% endblock %}
